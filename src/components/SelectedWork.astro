---
import { getCollection } from "astro:content";

const workItems = (await getCollection("work"))
  .filter((item) => item.data.featured)
  .sort((a, b) => a.data.order - b.data.order);

const backgroundPalette = [
  "#0b1020",
  "#0f1a14",
  "#1a1110",
  "#101321",
  "#12110f",
];

const backgroundForItem = (item, index) => {
  if (item.data.backgroundImage) {
    return `url('${item.data.backgroundImage}') top center / cover no-repeat`;
  }

  return backgroundPalette[index % backgroundPalette.length];
};

const getResponsiveBackgrounds = (item, index) => {
  const desktop = backgroundForItem(item, index);
  const tablet = item.data.backgroundImageTablet
    ? `url('${item.data.backgroundImageTablet}') top center / cover no-repeat`
    : desktop;
  const mobile = item.data.backgroundImageMobile
    ? `url('${item.data.backgroundImageMobile}') top center / cover no-repeat`
    : tablet;
  return { desktop, tablet, mobile };
};
---
<section id="selected-work" class="work-stack-container border-white/5 border-b">
  <div class="work-stack-bg" aria-hidden="true"></div>
  <div class="work-stack">
    {workItems.map((item, index) => {
      const bgs = getResponsiveBackgrounds(item, index);
      return (
      <section
        class="work-stack-section"
        style={`--stack-bg: ${bgs.desktop}; --stack-bg-tablet: ${bgs.tablet}; --stack-bg-mobile: ${bgs.mobile};`}
      >
        <div class="work-stack-content max-w-5xl mx-auto w-full px-6 md:px-0 md:w-[80%] lg:w-full">
          <article class="stacked-card work-stack-card w-full rounded-3xl border border-white/10 bg-zinc-950/70 backdrop-blur shadow-2xl shadow-black/40">
            <div class="px-8 py-10 border-b border-white/10">
              <p class="text-[0.7rem] uppercase tracking-[0.35em] text-zinc-500">
                Company
              </p>
              <h3 class="mt-3 text-3xl md:text-4xl font-semibold text-white">
                {item.data.title}
              </h3>
              {item.data.companyDescription ? (
                <p class="mt-2 text-sm text-zinc-400">
                  {item.data.companyDescription}
                </p>
              ) : null}
            </div>

            <div class="p-8 grid gap-6 md:grid-cols-[1.2fr_0.8fr]">
              <div class="space-y-4 text-sm text-zinc-300 leading-relaxed">
                <p>{item.data.summary}</p>
                <p>
                  <span class="text-white font-medium">Challenge:</span>
                  {" "}{item.data.challenge}
                </p>
                <p>
                  <span class="text-white font-medium">Solution:</span>
                  {" "}{item.data.solution}
                </p>
              </div>

              <div class="flex flex-col gap-4">
                <div class="text-xs font-mono text-zinc-500 border border-zinc-800 rounded px-2 py-1 w-fit">
                  {item.data.clientType}
                </div>
                <a
                  class="text-sm text-white font-medium hover:text-indigo-400 transition-colors"
                  href={`/work/${item.slug}`}
                >
                  View case study
                </a>
              </div>
            </div>

            {item.data.testimonial ? (
              <div class="px-8 py-6 border-t border-white/10">
                <blockquote class="text-sm text-zinc-300 italic">
                  {item.data.testimonial}
                </blockquote>
              </div>
            ) : null}
          </article>
        </div>
      </section>
    )})}
  </div>
</section>

<script>
  const container = document.querySelector("#selected-work");
  const sections = Array.from(document.querySelectorAll(".work-stack-section"));
  let transitionTimeout;
  if (sections.length) {
    let currentActive = sections[0];
    const initialBg = currentActive.style.getPropertyValue("--stack-bg");
    const initialBgTablet = currentActive.style.getPropertyValue("--stack-bg-tablet");
    const initialBgMobile = currentActive.style.getPropertyValue("--stack-bg-mobile");
    container?.style.setProperty("--stack-bg-current", initialBg);
    container?.style.setProperty("--stack-bg-next", initialBg);
    container?.style.setProperty("--stack-bg-tablet-current", initialBgTablet);
    container?.style.setProperty("--stack-bg-tablet-next", initialBgTablet);
    container?.style.setProperty("--stack-bg-mobile-current", initialBgMobile);
    container?.style.setProperty("--stack-bg-mobile-next", initialBgMobile);

    const observer = new IntersectionObserver(
      (entries) => {
        const visible = entries.filter((entry) => entry.isIntersecting);
        if (!visible.length) {
          return;
        }

        const next = visible.sort(
          (a, b) => b.intersectionRatio - a.intersectionRatio
        )[0]?.target;

        if (next && next !== currentActive) {
          const nextBg = next.style.getPropertyValue("--stack-bg");
          const nextBgTablet = next.style.getPropertyValue("--stack-bg-tablet");
          const nextBgMobile = next.style.getPropertyValue("--stack-bg-mobile");
          container?.style.setProperty("--stack-bg-next", nextBg);
          container?.style.setProperty("--stack-bg-tablet-next", nextBgTablet);
          container?.style.setProperty("--stack-bg-mobile-next", nextBgMobile);
          container?.classList.add("is-transitioning");
          if (transitionTimeout) {
            clearTimeout(transitionTimeout);
          }
          transitionTimeout = window.setTimeout(() => {
            container?.style.setProperty("--stack-bg-current", nextBg);
            container?.style.setProperty("--stack-bg-tablet-current", nextBgTablet);
            container?.style.setProperty("--stack-bg-mobile-current", nextBgMobile);
            container?.classList.remove("is-transitioning");
          }, 700);
          currentActive = next;
        }
      },
      { threshold: 0, rootMargin: "-45% 0px -45% 0px" }
    );

    sections.forEach((section) => observer.observe(section));
  }
</script>
