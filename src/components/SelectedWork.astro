---
import { getCollection } from "astro:content";

const workItems = (await getCollection("work"))
  .filter((item) => item.data.featured)
  .sort((a, b) => a.data.order - b.data.order);

const backgroundPalette = [
  "#0b1020",
  "#0f1a14",
  "#1a1110",
  "#101321",
  "#12110f",
];

const backgroundForItem = (item, index) => {
  if (item.data.backgroundImage) {
    return `url('${item.data.backgroundImage}') top center / cover no-repeat`;
  }

  return backgroundPalette[index % backgroundPalette.length];
};

const getResponsiveBackgrounds = (item, index) => {
  const desktop = backgroundForItem(item, index);
  const tablet = item.data.backgroundImageTablet
    ? `url('${item.data.backgroundImageTablet}') top center / cover no-repeat`
    : desktop;
  const mobile = item.data.backgroundImageMobile
    ? `url('${item.data.backgroundImageMobile}') top center / cover no-repeat`
    : tablet;
  return { desktop, tablet, mobile };
};
---
<section id="selected-work" class="work-stack-container bg-surface-950">
  <!-- Section header -->
  <div class="relative z-10 bg-surface-950 py-16 md:py-24 px-6 md:px-12 lg:px-16 border-b border-white/[0.06]">


  <div class="work-stack-bg" aria-hidden="true"></div>
  <div class="work-stack">
    {workItems.map((item, index) => {
      const bgs = getResponsiveBackgrounds(item, index);
      return (
        <section
          class="work-stack-section"
          style={`--stack-bg: ${bgs.desktop}; --stack-bg-tablet: ${bgs.tablet}; --stack-bg-mobile: ${bgs.mobile};`}
        >
          <div class="work-stack-content max-w-5xl mx-auto w-full px-6 md:px-12 lg:px-0">
            <article class="stacked-card work-stack-card w-full border border-white/[0.08] bg-surface-950/80 backdrop-blur-xl shadow-2xl shadow-black/60">
              <!-- Card Header -->
              <div class="px-8 md:px-10 py-8 md:py-10 border-b border-white/[0.06]">
                <div class="flex flex-wrap items-center gap-4 mb-4">
                  <span class="font-mono text-[10px] tracking-[0.2em] uppercase text-gold-500">
                    Case Study
                  </span>
                  <span class="w-px h-3 bg-white/20"></span>
                  <span class="font-mono text-[10px] tracking-[0.15em] uppercase text-surface-500">
                    {item.data.clientType}
                  </span>
                </div>
                <h3 class="heading-display text-3xl md:text-4xl lg:text-5xl text-white">
                  {item.data.title}
                </h3>
                {item.data.companyDescription && (
                  <p class="mt-3 text-sm text-surface-400 max-w-xl">
                    {item.data.companyDescription}
                  </p>
                )}
              </div>

              <!-- Card Body -->
              <div class="p-8 md:p-10 grid gap-8 md:grid-cols-[1.3fr_0.7fr]">
                <div class="space-y-6">
                  <p class="text-surface-300 leading-relaxed">{item.data.summary}</p>

                  <div class="space-y-4">
                    <div>
                      <span class="font-mono text-[10px] tracking-[0.15em] uppercase text-gold-500 block mb-2">Challenge</span>
                      <p class="text-sm text-surface-400 leading-relaxed">{item.data.challenge}</p>
                    </div>
                    <div>
                      <span class="font-mono text-[10px] tracking-[0.15em] uppercase text-gold-500 block mb-2">Solution</span>
                      <p class="text-sm text-surface-400 leading-relaxed">{item.data.solution}</p>
                    </div>
                  </div>
                </div>

                <div class="flex flex-col justify-end gap-6">
                                    <a
                    class="group inline-flex items-center gap-2 text-sm text-white font-medium hover:text-gold-500 transition-colors mt-auto"
                    href={`/${item.slug}`}
                  >
                    <span>View case study</span>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="transition-transform group-hover:translate-x-1"
                      aria-hidden="true"
                    >
                      <path d="M5 12h14m-7-7l7 7-7 7" />
                    </svg>
                  </a>
                </div>
              </div>

              <!-- Testimonial (if exists) -->
              {item.data.testimonial && (
                <div class="px-8 md:px-10 py-6 md:py-8 border-t border-white/[0.06] bg-white/[0.02]">
                  <blockquote class="relative">
                    <span class="absolute -top-2 -left-2 text-4xl text-gold-500/20 font-serif">"</span>
                    <p class="text-sm text-surface-300 italic leading-relaxed pl-4">
                      {item.data.testimonial}
                    </p>
                    {item.data.testimonialAuthor && (
                      <footer class="mt-4 pl-4">
                        <span class="text-sm text-surface-500">â€” {item.data.testimonialAuthor}</span>
                      </footer>
                    )}
                  </blockquote>
                </div>
              )}
            </article>
          </div>
        </section>
      );
    })}
  </div>
</section>

<script>
  const container = document.querySelector("#selected-work");
  const sections = Array.from(document.querySelectorAll(".work-stack-section"));
  let transitionTimeout;
  const scrollToSelectedWork = (behavior = "smooth") => {
    const firstSection = sections[0];
    if (!firstSection) {
      return;
    }
    const card = firstSection.querySelector(".work-stack-card") ?? firstSection;
    const rect = card.getBoundingClientRect();
    const top = window.scrollY + rect.top + rect.height / 2 - window.innerHeight / 2;
    window.scrollTo({ top: Math.max(0, top), behavior });
  };

  const handleSelectedWorkClick = (event) => {
    if (!(event.currentTarget instanceof HTMLAnchorElement)) {
      return;
    }
    event.preventDefault();
    if (window.location.hash !== "#selected-work") {
      history.pushState(null, "", "#selected-work");
    }
    scrollToSelectedWork("smooth");
  };

  document
    .querySelectorAll('a[href="#selected-work"]')
    .forEach((link) => link.addEventListener("click", handleSelectedWorkClick));

  window.addEventListener("hashchange", () => {
    if (window.location.hash === "#selected-work") {
      scrollToSelectedWork("smooth");
    }
  });

  if (window.location.hash === "#selected-work") {
    window.requestAnimationFrame(() => {
      window.requestAnimationFrame(() => scrollToSelectedWork("auto"));
    });
  }

  if (sections.length) {
    let currentActive = sections[0];
    const initialBg = currentActive.style.getPropertyValue("--stack-bg");
    const initialBgTablet = currentActive.style.getPropertyValue("--stack-bg-tablet");
    const initialBgMobile = currentActive.style.getPropertyValue("--stack-bg-mobile");
    container?.style.setProperty("--stack-bg-current", initialBg);
    container?.style.setProperty("--stack-bg-next", initialBg);
    container?.style.setProperty("--stack-bg-tablet-current", initialBgTablet);
    container?.style.setProperty("--stack-bg-tablet-next", initialBgTablet);
    container?.style.setProperty("--stack-bg-mobile-current", initialBgMobile);
    container?.style.setProperty("--stack-bg-mobile-next", initialBgMobile);

    const observer = new IntersectionObserver(
      (entries) => {
        const visible = entries.filter((entry) => entry.isIntersecting);
        if (!visible.length) {
          return;
        }

        const next = visible.sort(
          (a, b) => b.intersectionRatio - a.intersectionRatio
        )[0]?.target;

        if (next && next !== currentActive) {
          const nextBg = next.style.getPropertyValue("--stack-bg");
          const nextBgTablet = next.style.getPropertyValue("--stack-bg-tablet");
          const nextBgMobile = next.style.getPropertyValue("--stack-bg-mobile");
          container?.style.setProperty("--stack-bg-next", nextBg);
          container?.style.setProperty("--stack-bg-tablet-next", nextBgTablet);
          container?.style.setProperty("--stack-bg-mobile-next", nextBgMobile);
          container?.classList.add("is-transitioning");
          if (transitionTimeout) {
            clearTimeout(transitionTimeout);
          }
          transitionTimeout = window.setTimeout(() => {
            container?.style.setProperty("--stack-bg-current", nextBg);
            container?.style.setProperty("--stack-bg-tablet-current", nextBgTablet);
            container?.style.setProperty("--stack-bg-mobile-current", nextBgMobile);
            container?.classList.remove("is-transitioning");
          }, 700);
          currentActive = next;
        }
      },
      { threshold: 0, rootMargin: "-45% 0px -45% 0px" }
    );

    sections.forEach((section) => observer.observe(section));
  }
</script>
